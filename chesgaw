// Array to track selected blocks
selectedBlocks: { startWeek: number; endWeek: number }[] = [];

// Function to create a wave
createWave(): void {
  const selectedWeeks = this.selection.selected;

  if (selectedWeeks.length < 2) {
    this.errorMessage = "A wave must contain at least 2 weeks.";
    return;
  }

  // Sort selected weeks by their original index in the left grid
  const sortedWeeks = selectedWeeks.sort((a, b) => this.leftGridData.data.indexOf(a) - this.leftGridData.data.indexOf(b));

  // Get start and end week from sorted weeks
  const startWeek = parseInt(sortedWeeks[0].startWeek, 10);
  const endWeek = parseInt(sortedWeeks[sortedWeeks.length - 1].startWeek, 10);

  // Check if new selection falls between any existing blocks
  const newBlockStart = Math.min(...selectedWeeks.map(week => parseInt(week.startWeek, 10)));
  const newBlockEnd = Math.max(...selectedWeeks.map(week => parseInt(week.startWeek, 10)));

  const isValidSelection = this.selectedBlocks.every(block => 
    newBlockEnd < block.startWeek || newBlockStart > block.endWeek
  );

  if (!isValidSelection) {
    this.errorMessage = "Selected weeks cannot fall between existing selected blocks.";
    return;
  }

  // Add the new block to the selected blocks
  this.selectedBlocks.push({ startWeek, endWeek });

  // Reset error message
  this.errorMessage = '';

  const maxDueDate = new Date(sortedWeeks[sortedWeeks.length - 1].endDate);
  maxDueDate.setDate(maxDueDate.getDate() + 7);
  const minDueDate = new Date(sortedWeeks[0].startDate);
  minDueDate.setDate(minDueDate.getDate() - 7);

  const formatToDateTimeString = (date: Date): string => {
    const isoString = date.toISOString();
    return isoString.slice(0, 16);  // Extract 'YYYY-MM-DDTHH:MM' portion
  };

  const wave = {
    startWeek: `${startWeek} (${sortedWeeks[0].startDate} - ${sortedWeeks[0].endDate})`,
    endWeek: `${endWeek} (${sortedWeeks[sortedWeeks.length - 1].startDate} - ${sortedWeeks[sortedWeeks.length - 1].endDate})`,
    startDate: sortedWeeks[0].startDate,
    endDate: sortedWeeks[sortedWeeks.length - 1].endDate,
    dueDate: '',
    minDueDate: formatToDateTimeString(minDueDate),
    maxDueDate: formatToDateTimeString(maxDueDate)
  };

  this.rightGridData.data = [...this.rightGridData.data, wave];
  this.leftGridData.data = this.leftGridData.data.filter(item => !this.selection.isSelected(item));
  this.selection.clear();
}
