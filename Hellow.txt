using Microsoft.AspNetCore.Mvc;
using System.Threading.Tasks;
using System.Xml.Serialization;
using System.IO;

[ApiController]
[Route("[controller]")]
public class DataController : ControllerBase
{
    private readonly MyDbContext _context;

    public DataController(MyDbContext context)
    {
        _context = context;
    }

    [HttpGet("getdata")]
    public async Task<IActionResult> GetData(string parameter, string format = "json")
    {
        var result = await _context.CallStoredProcedureAsync(parameter);

        if (format.ToLower() == "xml")
        {
            return new ContentResult
            {
                Content = SerializeToXml(result),
                ContentType = "application/xml",
                StatusCode = 200
            };
        }

        return Ok(result);
    }

    private string SerializeToXml(object data)
    {
        using (var stringwriter = new StringWriter())
        {
            var serializer = new XmlSerializer(data.GetType());
            serializer.Serialize(stringwriter, data);
            return stringwriter.ToString();
        }
    }
}
