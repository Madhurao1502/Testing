<!-- ============================================================ -->
<!-- TABLE 1: Proximity FSR Table (Closest FSRs) -->
<!-- ============================================================ -->
<mat-expansion-panel class="accordion-panel" [expanded]="true">
  <mat-expansion-panel-header class="accordion-header">
    <mat-panel-title>
      <mat-icon>location_on</mat-icon>
      Closest FSRs
    </mat-panel-title>
  </mat-expansion-panel-header>

  <div class="table-section proximity-section">
    <div *ngIf="isLoadingProximity" class="loading-container">
      <mat-spinner diameter="30"></mat-spinner>
      <span>Loading proximity data...</span>
    </div>

    <div class="table-wrapper" *ngIf="!isLoadingProximity && proximityDataSource.data.length > 0">
      <table mat-table [dataSource]="proximityDataSource" class="proximity-table mat-elevation-z2">

        <!-- ACTION COLUMN - SINGLE BUTTON (Assign or Unassign) -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef class="col-action">Action</th>
          <td mat-cell *matCellDef="let fsr">
            <!-- ASSIGN BUTTON - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!isAlreadyAssignedProximity(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignFromProximity(fsr)"
              class="action-button no-border"
              [disabled]="taskSelection.selected.length === 0"
            >
              <mat-icon>person_add</mat-icon>
              Assign
            </button>

            <!-- UNASSIGN BUTTON - Shows only when FSR IS assigned -->
            <button
              *ngIf="isAlreadyAssignedProximity(fsr)"
              mat-stroked-button
              color="warn"
              (click)="unassignFromProximity(fsr)"
              class="action-button no-border"
              [disabled]="taskSelection.selected.length === 0"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign
            </button>
          </td>
        </ng-container>

        <!-- Employee ID Column -->
        <ng-container matColumnDef="empId">
          <th mat-header-cell *matHeaderCellDef class="col-emp-id">Employee ID</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.empId }}</td>
        </ng-container>

        <!-- Employee Name Column -->
        <ng-container matColumnDef="empName">
          <th mat-header-cell *matHeaderCellDef class="col-emp-name">Name</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.firstName }} {{ fsr.lastName }}</td>
        </ng-container>

        <!-- Productivity Column -->
        <ng-container matColumnDef="productivity">
          <th mat-header-cell *matHeaderCellDef class="col-productivity">Productivity</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.productivity }}</td>
        </ng-container>

        <!-- Cost Column -->
        <ng-container matColumnDef="cost">
          <th mat-header-cell *matHeaderCellDef class="col-cost">Cost</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.totalCost }}</td>
        </ng-container>

        <!-- Travel Time Column -->
        <ng-container matColumnDef="time">
          <th mat-header-cell *matHeaderCellDef class="col-time">Travel Time</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.time }}</td>
        </ng-container>

        <!-- Toll Column -->
        <ng-container matColumnDef="toll">
          <th mat-header-cell *matHeaderCellDef class="col-toll">Toll</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.toll }}</td>
        </ng-container>

        <!-- Phone Column -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef class="col-phone">Phone</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.fsrPhoneNum }}</td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef class="col-email">Email</th>
          <td mat-cell *matCellDef="let fsr">
            <a href="mailto:{{ fsr.email }}" class="email-link">{{ fsr.email }}</a>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="proximityColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: proximityColumns"></tr>
      </table>
    </div>

    <div *ngIf="!isLoadingProximity && proximityDataSource.data.length === 0" class="no-data">
      No proximity data available for this store.
    </div>
  </div>
</mat-expansion-panel>

<!-- ============================================================ -->
<!-- TABLE 2: Current Assignment / Search FSR Table -->
<!-- ============================================================ -->
<mat-expansion-panel class="accordion-panel" [expanded]="true">
  <mat-expansion-panel-header class="accordion-header">
    <mat-panel-title>
      <mat-icon>search</mat-icon>
      Search & Assign FSRs
    </mat-panel-title>
  </mat-expansion-panel-header>

  <div class="table-section fsr-section">
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="30"></mat-spinner>
      <span>Loading FSRs...</span>
    </div>

    <!-- FSR Table -->
    <div class="table-wrapper" *ngIf="!isLoading">
      <table mat-table [dataSource]="fsrDataSource" class="fsr-table mat-elevation-z2">

        <!-- ACTION COLUMN - SINGLE BUTTON (Assign or Unassign) -->
        <ng-container matColumnDef="action">
          <mat-header-cell *matHeaderCellDef class="col-action">Action</mat-header-cell>
          <mat-cell *matCellDef="let fsr">
            <!-- ASSIGN ALL BUTTON - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'assign_all') && !isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignTask(fsr, 2)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_add</mat-icon>
              Assign All
            </button>

            <!-- UNASSIGN ALL BUTTON - Shows only when FSR IS assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'unassign_all') && isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="warn"
              [disabled]="taskSelection.selected.length === 0"
              (click)="assignTask(fsr, 4)"
              class="action-button no-border"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign All
            </button>

            <!-- ASSIGN BUTTON (TASK LEVEL) - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'assign') && !isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignTask(fsr, 1)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_add</mat-icon>
              Assign
            </button>

            <!-- UNASSIGN BUTTON (TASK LEVEL) - Shows only when FSR IS assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'unassign') && isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="warn"
              (click)="assignTask(fsr, 3)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign
            </button>
          </mat-cell>
        </ng-container>

        <!-- FSR Information Columns -->
        <ng-container matColumnDef="name">
          <mat-header-cell *matHeaderCellDef class="col-name">Name</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-name">
            {{ fsr.LastName }}, {{ fsr.FirstName }}
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="address">
          <mat-header-cell *matHeaderCellDef class="col-address">Address</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-address">{{ fsr.AddrLine1 }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="assigned_hrs">
          <mat-header-cell *matHeaderCellDef class="col-assigned-hrs">Assigned Hrs</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-assigned-hrs">{{ fsr.AssignedHrs }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="max_hrs">
          <mat-header-cell *matHeaderCellDef class="col-max-hrs">Max Hours</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-max-hrs">{{ fsr.MaxHrs }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="cluster">
          <mat-header-cell *matHeaderCellDef class="col-cluster">Cluster</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-cluster">{{ fsr.PositionName }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="contact">
          <mat-header-cell *matHeaderCellDef class="col-contact">Contact</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-contact">
            <div class="contact-item">{{ fsr.FsrPhoneNum }}</div>
            <div class="contact-item">
              <a href="mailto:{{ fsr.FsrEmailID }}" class="contact-link">{{ fsr.FsrEmailID }}</a>
            </div>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="getDisplayedColumns2(); sticky: true"></mat-header-row>
        <mat-row *matRowDef="let row; columns: getDisplayedColumns2()"></mat-row>
      </table>

      <div *ngIf="fsrDataSource.data.length === 0 && !isLoading" class="no-data">
        No FSRs found. Please adjust your search criteria.
      </div>
    </div>
  </div>
</mat-expansion-panel>



............

assignment-component.ts
// ============================================================
// ADD THIS METHOD TO YOUR COMPONENT CLASS
// ============================================================

/**
 * Check if a Proximity FSR is already assigned to any task
 * This method determines whether to show Assign or Unassign button
 */
isAlreadyAssignedProximity(fsr: ProximityFsr): boolean {
  // Return false if task data not loaded yet
  if (
    !this.taskAssignmentDataSource.data ||
    this.taskAssignmentDataSource.data.length === 0
  ) {
    return false;
  }

  // Search through task rows for matching empId
  const isAssigned = this.taskAssignmentDataSource.data.some((task) => {
    // Skip the "ALL" row and disabled rows
    if (task.isAllTask || !task.assignedTo || task.assignedTo === 'Not Assigned') {
      return false;
    }

    // Method 1: Direct empId match
    if (task.empId === fsr.empId) {
      return true;
    }

    // Method 2: Check if assignedTo contains FSR's empId
    if (task.assignedTo.includes(fsr.empId)) {
      return true;
    }

    return false;
  });

  return isAssigned;
}

// ============================================================
// UPDATE THE proximityColumns ARRAY
// ============================================================

// Change from:
// proximityColumns: string[] = ['assign','unassign', 'empId','empName','productivity','cost', 'time', 'toll', 'phone', 'email'];

// To:
proximityColumns: string[] = ['action', 'empId', 'empName', 'productivity', 'cost', 'time', 'toll', 'phone', 'email'];

// ============================================================
// UPDATE THE getDisplayedColumns() METHOD - FOR TABLE 2
// ============================================================

private getDisplayedColumns(): string[] {
  const columns: string[] = [];

  // Add SINGLE action column based on mode (NOT two separate ones)
  columns.push('action'); // This replaces 'assign_all', 'unassign_all', 'assign', 'unassign'

  // Add info columns
  columns.push('name', 'address', 'assigned_hrs', 'max_hrs', 'cluster', 'contact');

  return columns;
}

// ============================================================
// REMOVE THESE OLD COLUMN DEFINITIONS FROM TEMPLATE
// ============================================================

// DELETE the old ng-container definitions for:
// - matColumnDef="assign_all"
// - matColumnDef="unassign_all"  
// - matColumnDef="assign"
// - matColumnDef="unassign"
// - showColumn() method is no longer needed

// These are now replaced with dynamic button logic inside the single "action" column

// ============================================================
// OPTIONAL: SIMPLIFY THE showColumn() CHECK
// ============================================================

// The old method:
// showColumn(columnName: string): boolean {
//   return this.displayedColumns.includes(columnName);
// }

// Is no longer needed since all conditional logic is now in the template 
// with *ngIf statements based on assignment status



