
TABLE 2: CORRECTED SINGLE ACTION COLUMN -->
<!-- Only ONE button shows: either Assign OR Unassign -->
<!-- Button changes based on what user selects in Table 3 -->

<ng-container matColumnDef="action">
  <mat-header-cell *matHeaderCellDef class="col-action">Action</mat-header-cell>
  <mat-cell *matCellDef="let fsr">

    <!-- CASE 1: ALL ROW SELECTED IN TABLE 3 -->
    <!-- Show Assign All or Unassign All based on FSR assignment status -->
    <ng-container *ngIf="isAllTaskSelected()">
      <!-- Show ASSIGN ALL button if FSR is NOT assigned -->
      <button
        *ngIf="!isAlreadyAssignedFsr(fsr)"
        mat-stroked-button
        color="primary"
        (click)="assignTask(fsr, 2)"
        [disabled]="taskSelection.selected.length === 0"
        class="action-button no-border"
      >
        <mat-icon>person_add</mat-icon>
        Assign All
      </button>

      <!-- Show UNASSIGN ALL button if FSR IS assigned -->
      <button
        *ngIf="isAlreadyAssignedFsr(fsr)"
        mat-stroked-button
        color="warn"
        (click)="assignTask(fsr, 4)"
        [disabled]="taskSelection.selected.length === 0"
        class="action-button no-border"
      >
        <mat-icon>person_remove</mat-icon>
        Unassign All
      </button>
    </ng-container>

    <!-- CASE 2: SPECIFIC TASK(S) SELECTED IN TABLE 3 -->
    <!-- Show Assign or Unassign based on FSR assignment status -->
    <ng-container *ngIf="!isAllTaskSelected() && taskSelection.selected.length > 0">
      <!-- Show ASSIGN button if FSR is NOT assigned -->
      <button
        *ngIf="!isAlreadyAssignedFsr(fsr)"
        mat-stroked-button
        color="primary"
        (click)="assignTask(fsr, 1)"
        [disabled]="taskSelection.selected.length === 0"
        class="action-button no-border"
      >
        <mat-icon>person_add</mat-icon>
        Assign
      </button>

      <!-- Show UNASSIGN button if FSR IS assigned -->
      <button
        *ngIf="isAlreadyAssignedFsr(fsr)"
        mat-stroked-button
        color="warn"
        (click)="assignTask(fsr, 3)"
        [disabled]="taskSelection.selected.length === 0"
        class="action-button no-border"
      >
        <mat-icon>person_remove</mat-icon>
        Unassign
      </button>
    </ng-container>

    <!-- CASE 3: NO TASK SELECTED IN TABLE 3 -->
    <!-- Hide all buttons when no selection -->
    <!-- (Nothing renders) -->

  </mat-cell>
</ng-container>


/ ============================================================
// ADD THESE HELPER METHODS TO YOUR COMPONENT CLASS
// ============================================================

/**
 * Check if the "ALL" task row is currently selected in Table 3
 * Returns true if user selected the ALL row
 */
isAllTaskSelected(): boolean {
  const allRow = this.taskAssignmentDataSource.data.find((r) => r.isAllTask);
  
  if (!allRow) {
    return false;
  }
  
  return this.taskSelection.isSelected(allRow);
}

/**
 * Get count of specific (non-ALL) tasks selected in Table 3
 */
getSpecificTasksSelectedCount(): number {
  return this.taskSelection.selected.filter((row) => !row.isAllTask).length;
}

/**
 * Check if any specific task is selected (not ALL row)
 */
isAnySpecificTaskSelected(): boolean {
  return this.getSpecificTasksSelectedCount() > 0;
}

// ============================================================
// UPDATE: isAlreadyAssignedFsr() - ALREADY EXISTS, NO CHANGE
// ============================================================
// The existing isAlreadyAssignedFsr() method remains the same
// It checks if an FSR is already assigned to any task by empId match

// ============================================================
// UPDATE: assignTask() METHOD - IMPORTANT FIX
// ============================================================
// The existing assignTask() method should work as-is
// BUT make sure it handles these action codes correctly:

// Action Code Reference:
// 1 = Assign specific task (when user selects specific tasks in Table 3)
// 2 = Assign all tasks (when user selects ALL in Table 3)
// 3 = Unassign specific task (when user selects specific tasks in Table 3)
// 4 = Unassign all tasks (when user selects ALL in Table 3)

/**
 * UPDATED: Improved assignTask() method (Table 2)
 * Now correctly uses action codes based on Table 3 selection
 */
async assignTask(fsr: any, action: number): Promise<void> {
  const selectedRows = this.taskSelection.selected;
  
  // Check if at least one task is selected
  if (selectedRows.length === 0) {
    alert('Please select at least one task to perform this action.');
    return;
  }

  const fsrName = `${fsr.FirstName} ${fsr.LastName}`;
  const fsrId = fsr.EmpId || fsr.empid || fsr.empId;
  
  // Determine if ALL row is selected
  const allRowSelected = selectedRows.some((row) => row.isAllTask);
  
  // Build confirmation message based on action
  let confirmMessage = '';
  let targetDescription = '';
  
  if (action === 2) {
    // Assign all
    confirmMessage = `Are you sure you want to assign ${fsrName} to ALL tasks?`;
    targetDescription = 'all tasks';
  } else if (action === 4) {
    // Unassign all
    confirmMessage = `Are you sure you want to unassign ${fsrName} from ALL tasks?`;
    targetDescription = 'all tasks';
  } else if (action === 1) {
    // Assign specific task(s)
    const specificTasks = selectedRows.filter((row) => !row.isAllTask);
    const taskNames = specificTasks.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to assign ${fsrName} to ${taskNames}?`;
    targetDescription = taskNames;
  } else if (action === 3) {
    // Unassign specific task(s)
    const specificTasks = selectedRows.filter((row) => !row.isAllTask);
    const taskNames = specificTasks.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to unassign ${fsrName} from ${taskNames}?`;
    targetDescription = taskNames;
  }

  if (!confirm(confirmMessage)) {
    return;
  }

  this.showSpinner = true;
  try {
    if (action === 2 || action === 4) {
      // Assign All or Unassign All
      const params = {
        iriweek: this.data.iriWeek,
        territoryid: this.filterForm.get('territory')?.value,
        storenumber: this.data.storeNumber,
        empid: fsrId,
        tasknumber: '', // Empty for ALL
        positionnumber: this.data.positionNumber,
        action: action, // 2 or 4
        assignmentmode: 'StoreLevel',
        countryId: this.commonService.getCurrentCountry(),
      };

      console.log('Saving assignment (ALL):', params);

      await firstValueFrom(
        this.http.post(
          this.baseUrl + 'api/TaskAssinment/SaveAssignment',
          params
        )
      );
    } else if (action === 1 || action === 3) {
      // Assign or Unassign specific task(s)
      // Only process non-ALL rows
      const specificTasks = selectedRows.filter((row) => !row.isAllTask);
      
      if (specificTasks.length === 0) {
        alert('No specific tasks selected.');
        return;
      }

      // Process each specific task
      for (const row of specificTasks) {
        const params = {
          iriweek: this.data.iriWeek,
          territoryid: this.filterForm.get('territory')?.value,
          storenumber: row.storeNumber,
          empid: fsrId,
          tasknumber: row.taskNumber,
          positionnumber: this.data.positionNumber,
          action: action, // 1 or 3
          assignmentmode: 'TaskLevel',
          countryId: this.commonService.getCurrentCountry(),
        };

        console.log('Saving assignment (Specific Task):', params);

        await firstValueFrom(
          this.http.post(
            this.baseUrl + 'api/TaskAssinment/SaveAssignment',
            params
          )
        );
      }
    }

    this.hasChanges = true;

    // Reload all data to refresh the UI and button states
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    await this.loadProximityData();
    
    // Keep task selection (don't clear it)
    // so user can see what was just modified
    
    this.filterForm.patchValue({ firstName: '', lastName: '' });
    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment. Please try again.');
  } finally {
    this.showSpinner = false;
  }
}

// ============================================================
// EXAMPLE OF HOW THE NEW LOGIC WORKS:
// ============================================================

/*
SCENARIO 1: User selects "ALL" row in Table 3
- isAllTaskSelected() returns TRUE
- Both buttons check: !isAlreadyAssignedFsr(fsr)
- If FSR not assigned:
  * SHOW "Assign All" button (action=2)
  * HIDE "Unassign All" button
- If FSR is assigned:
  * HIDE "Assign All" button
  * SHOW "Unassign All" button (action=4)
- Result: Only ONE button visible

SCENARIO 2: User selects specific task (e.g., "Task A", "Task B") in Table 3
- isAllTaskSelected() returns FALSE
- taskSelection.selected.length > 0 returns TRUE
- Both buttons check: !isAlreadyAssignedFsr(fsr)
- If FSR not assigned:
  * SHOW "Assign" button (action=1)
  * HIDE "Unassign" button
- If FSR is assigned:
  * HIDE "Assign" button
  * SHOW "Unassign" button (action=3)
- Result: Only ONE button visible

SCENARIO 3: User has NOT selected any task in Table 3
- isAllTaskSelected() returns FALSE
- taskSelection.selected.length === 0 returns TRUE
- Both ng-containers have *ngIf that evaluate to FALSE
- Result: NO buttons visible (clean UI)
*/
//////////////////////////////////////////////////////////////////
<!-- ============================================================ -->
<!-- TABLE 1: Proximity FSR Table (Closest FSRs) -->
<!-- ============================================================ -->
<mat-expansion-panel class="accordion-panel" [expanded]="true">
  <mat-expansion-panel-header class="accordion-header">
    <mat-panel-title>
      <mat-icon>location_on</mat-icon>
      Closest FSRs
    </mat-panel-title>
  </mat-expansion-panel-header>

  <div class="table-section proximity-section">
    <div *ngIf="isLoadingProximity" class="loading-container">
      <mat-spinner diameter="30"></mat-spinner>
      <span>Loading proximity data...</span>
    </div>

    <div class="table-wrapper" *ngIf="!isLoadingProximity && proximityDataSource.data.length > 0">
      <table mat-table [dataSource]="proximityDataSource" class="proximity-table mat-elevation-z2">

        <!-- ACTION COLUMN - SINGLE BUTTON (Assign or Unassign) -->
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef class="col-action">Action</th>
          <td mat-cell *matCellDef="let fsr">
            <!-- ASSIGN BUTTON - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!isAlreadyAssignedProximity(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignFromProximity(fsr)"
              class="action-button no-border"
              [disabled]="taskSelection.selected.length === 0"
            >
              <mat-icon>person_add</mat-icon>
              Assign
            </button>

            <!-- UNASSIGN BUTTON - Shows only when FSR IS assigned -->
            <button
              *ngIf="isAlreadyAssignedProximity(fsr)"
              mat-stroked-button
              color="warn"
              (click)="unassignFromProximity(fsr)"
              class="action-button no-border"
              [disabled]="taskSelection.selected.length === 0"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign
            </button>
          </td>
        </ng-container>

        <!-- Employee ID Column -->
        <ng-container matColumnDef="empId">
          <th mat-header-cell *matHeaderCellDef class="col-emp-id">Employee ID</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.empId }}</td>
        </ng-container>

        <!-- Employee Name Column -->
        <ng-container matColumnDef="empName">
          <th mat-header-cell *matHeaderCellDef class="col-emp-name">Name</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.firstName }} {{ fsr.lastName }}</td>
        </ng-container>

        <!-- Productivity Column -->
        <ng-container matColumnDef="productivity">
          <th mat-header-cell *matHeaderCellDef class="col-productivity">Productivity</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.productivity }}</td>
        </ng-container>

        <!-- Cost Column -->
        <ng-container matColumnDef="cost">
          <th mat-header-cell *matHeaderCellDef class="col-cost">Cost</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.totalCost }}</td>
        </ng-container>

        <!-- Travel Time Column -->
        <ng-container matColumnDef="time">
          <th mat-header-cell *matHeaderCellDef class="col-time">Travel Time</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.time }}</td>
        </ng-container>

        <!-- Toll Column -->
        <ng-container matColumnDef="toll">
          <th mat-header-cell *matHeaderCellDef class="col-toll">Toll</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.toll }}</td>
        </ng-container>

        <!-- Phone Column -->
        <ng-container matColumnDef="phone">
          <th mat-header-cell *matHeaderCellDef class="col-phone">Phone</th>
          <td mat-cell *matCellDef="let fsr">{{ fsr.fsrPhoneNum }}</td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef class="col-email">Email</th>
          <td mat-cell *matCellDef="let fsr">
            <a href="mailto:{{ fsr.email }}" class="email-link">{{ fsr.email }}</a>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="proximityColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: proximityColumns"></tr>
      </table>
    </div>

    <div *ngIf="!isLoadingProximity && proximityDataSource.data.length === 0" class="no-data">
      No proximity data available for this store.
    </div>
  </div>
</mat-expansion-panel>

<!-- ============================================================ -->
<!-- TABLE 2: Current Assignment / Search FSR Table -->
<!-- ============================================================ -->
<mat-expansion-panel class="accordion-panel" [expanded]="true">
  <mat-expansion-panel-header class="accordion-header">
    <mat-panel-title>
      <mat-icon>search</mat-icon>
      Search & Assign FSRs
    </mat-panel-title>
  </mat-expansion-panel-header>

  <div class="table-section fsr-section">
    <!-- Loading Indicator -->
    <div *ngIf="isLoading" class="loading-container">
      <mat-spinner diameter="30"></mat-spinner>
      <span>Loading FSRs...</span>
    </div>

    <!-- FSR Table -->
    <div class="table-wrapper" *ngIf="!isLoading">
      <table mat-table [dataSource]="fsrDataSource" class="fsr-table mat-elevation-z2">

        <!-- ACTION COLUMN - SINGLE BUTTON (Assign or Unassign) -->
        <ng-container matColumnDef="action">
          <mat-header-cell *matHeaderCellDef class="col-action">Action</mat-header-cell>
          <mat-cell *matCellDef="let fsr">
            <!-- ASSIGN ALL BUTTON - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'assign_all') && !isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignTask(fsr, 2)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_add</mat-icon>
              Assign All
            </button>

            <!-- UNASSIGN ALL BUTTON - Shows only when FSR IS assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'unassign_all') && isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="warn"
              [disabled]="taskSelection.selected.length === 0"
              (click)="assignTask(fsr, 4)"
              class="action-button no-border"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign All
            </button>

            <!-- ASSIGN BUTTON (TASK LEVEL) - Shows only when FSR is NOT assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'assign') && !isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="primary"
              (click)="assignTask(fsr, 1)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_add</mat-icon>
              Assign
            </button>

            <!-- UNASSIGN BUTTON (TASK LEVEL) - Shows only when FSR IS assigned -->
            <button
              *ngIf="!shouldDisableButton(fsr, 'unassign') && isAlreadyAssignedFsr(fsr)"
              mat-stroked-button
              color="warn"
              (click)="assignTask(fsr, 3)"
              [disabled]="taskSelection.selected.length === 0"
              class="action-button no-border"
            >
              <mat-icon>person_remove</mat-icon>
              Unassign
            </button>
          </mat-cell>
        </ng-container>

        <!-- FSR Information Columns -->
        <ng-container matColumnDef="name">
          <mat-header-cell *matHeaderCellDef class="col-name">Name</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-name">
            {{ fsr.LastName }}, {{ fsr.FirstName }}
          </mat-cell>
        </ng-container>

        <ng-container matColumnDef="address">
          <mat-header-cell *matHeaderCellDef class="col-address">Address</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-address">{{ fsr.AddrLine1 }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="assigned_hrs">
          <mat-header-cell *matHeaderCellDef class="col-assigned-hrs">Assigned Hrs</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-assigned-hrs">{{ fsr.AssignedHrs }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="max_hrs">
          <mat-header-cell *matHeaderCellDef class="col-max-hrs">Max Hours</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-max-hrs">{{ fsr.MaxHrs }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="cluster">
          <mat-header-cell *matHeaderCellDef class="col-cluster">Cluster</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-cluster">{{ fsr.PositionName }}</mat-cell>
        </ng-container>

        <ng-container matColumnDef="contact">
          <mat-header-cell *matHeaderCellDef class="col-contact">Contact</mat-header-cell>
          <mat-cell *matCellDef="let fsr" class="col-contact">
            <div class="contact-item">{{ fsr.FsrPhoneNum }}</div>
            <div class="contact-item">
              <a href="mailto:{{ fsr.FsrEmailID }}" class="contact-link">{{ fsr.FsrEmailID }}</a>
            </div>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="getDisplayedColumns2(); sticky: true"></mat-header-row>
        <mat-row *matRowDef="let row; columns: getDisplayedColumns2()"></mat-row>
      </table>

      <div *ngIf="fsrDataSource.data.length === 0 && !isLoading" class="no-data">
        No FSRs found. Please adjust your search criteria.
      </div>
    </div>
  </div>
</mat-expansion-panel>



............

assignment-component.ts
// ============================================================
// ADD THIS METHOD TO YOUR COMPONENT CLASS
// ============================================================

/**
 * Check if a Proximity FSR is already assigned to any task
 * This method determines whether to show Assign or Unassign button
 */
isAlreadyAssignedProximity(fsr: ProximityFsr): boolean {
  // Return false if task data not loaded yet
  if (
    !this.taskAssignmentDataSource.data ||
    this.taskAssignmentDataSource.data.length === 0
  ) {
    return false;
  }

  // Search through task rows for matching empId
  const isAssigned = this.taskAssignmentDataSource.data.some((task) => {
    // Skip the "ALL" row and disabled rows
    if (task.isAllTask || !task.assignedTo || task.assignedTo === 'Not Assigned') {
      return false;
    }

    // Method 1: Direct empId match
    if (task.empId === fsr.empId) {
      return true;
    }

    // Method 2: Check if assignedTo contains FSR's empId
    if (task.assignedTo.includes(fsr.empId)) {
      return true;
    }

    return false;
  });

  return isAssigned;
}

// ============================================================
// UPDATE THE proximityColumns ARRAY
// ============================================================

// Change from:
// proximityColumns: string[] = ['assign','unassign', 'empId','empName','productivity','cost', 'time', 'toll', 'phone', 'email'];

// To:
proximityColumns: string[] = ['action', 'empId', 'empName', 'productivity', 'cost', 'time', 'toll', 'phone', 'email'];

// ============================================================
// UPDATE THE getDisplayedColumns() METHOD - FOR TABLE 2
// ============================================================

private getDisplayedColumns(): string[] {
  const columns: string[] = [];

  // Add SINGLE action column based on mode (NOT two separate ones)
  columns.push('action'); // This replaces 'assign_all', 'unassign_all', 'assign', 'unassign'

  // Add info columns
  columns.push('name', 'address', 'assigned_hrs', 'max_hrs', 'cluster', 'contact');

  return columns;
}

// ============================================================
// REMOVE THESE OLD COLUMN DEFINITIONS FROM TEMPLATE
// ============================================================

// DELETE the old ng-container definitions for:
// - matColumnDef="assign_all"
// - matColumnDef="unassign_all"  
// - matColumnDef="assign"
// - matColumnDef="unassign"
// - showColumn() method is no longer needed

// These are now replaced with dynamic button logic inside the single "action" column

// ============================================================
// OPTIONAL: SIMPLIFY THE showColumn() CHECK
// ============================================================

// The old method:
// showColumn(columnName: string): boolean {
//   return this.displayedColumns.includes(columnName);
// }

// Is no longer needed since all conditional logic is now in the template 
// with *ngIf statements based on assignment status



