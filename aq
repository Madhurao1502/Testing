/ ============================================================
// ADD THESE HELPER METHODS TO YOUR COMPONENT CLASS
// ============================================================

/**
 * Check if the "ALL" task row is currently selected in Table 3
 * Returns true if user selected the ALL row
 */
isAllTaskSelected(): boolean {
  const allRow = this.taskAssignmentDataSource.data.find((r) => r.isAllTask);
  
  if (!allRow) {
    return false;
  }
  
  return this.taskSelection.isSelected(allRow);
}

/**
 * Get count of specific (non-ALL) tasks selected in Table 3
 */
getSpecificTasksSelectedCount(): number {
  return this.taskSelection.selected.filter((row) => !row.isAllTask).length;
}

/**
 * Check if any specific task is selected (not ALL row)
 */
isAnySpecificTaskSelected(): boolean {
  return this.getSpecificTasksSelectedCount() > 0;
}

// ============================================================
// UPDATE: isAlreadyAssignedFsr() - ALREADY EXISTS, NO CHANGE
// ============================================================
// The existing isAlreadyAssignedFsr() method remains the same
// It checks if an FSR is already assigned to any task by empId match

// ============================================================
// UPDATE: assignTask() METHOD - IMPORTANT FIX
// ============================================================
// The existing assignTask() method should work as-is
// BUT make sure it handles these action codes correctly:

// Action Code Reference:
// 1 = Assign specific task (when user selects specific tasks in Table 3)
// 2 = Assign all tasks (when user selects ALL in Table 3)
// 3 = Unassign specific task (when user selects specific tasks in Table 3)
// 4 = Unassign all tasks (when user selects ALL in Table 3)

/**
 * UPDATED: Improved assignTask() method (Table 2)
 * Now correctly uses action codes based on Table 3 selection
 */
async assignTask(fsr: any, action: number): Promise<void> {
  const selectedRows = this.taskSelection.selected;
  
  // Check if at least one task is selected
  if (selectedRows.length === 0) {
    alert('Please select at least one task to perform this action.');
    return;
  }

  const fsrName = `${fsr.FirstName} ${fsr.LastName}`;
  const fsrId = fsr.EmpId || fsr.empid || fsr.empId;
  
  // Determine if ALL row is selected
  const allRowSelected = selectedRows.some((row) => row.isAllTask);
  
  // Build confirmation message based on action
  let confirmMessage = '';
  let targetDescription = '';
  
  if (action === 2) {
    // Assign all
    confirmMessage = `Are you sure you want to assign ${fsrName} to ALL tasks?`;
    targetDescription = 'all tasks';
  } else if (action === 4) {
    // Unassign all
    confirmMessage = `Are you sure you want to unassign ${fsrName} from ALL tasks?`;
    targetDescription = 'all tasks';
  } else if (action === 1) {
    // Assign specific task(s)
    const specificTasks = selectedRows.filter((row) => !row.isAllTask);
    const taskNames = specificTasks.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to assign ${fsrName} to ${taskNames}?`;
    targetDescription = taskNames;
  } else if (action === 3) {
    // Unassign specific task(s)
    const specificTasks = selectedRows.filter((row) => !row.isAllTask);
    const taskNames = specificTasks.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to unassign ${fsrName} from ${taskNames}?`;
    targetDescription = taskNames;
  }

  if (!confirm(confirmMessage)) {
    return;
  }

  this.showSpinner = true;
  try {
    if (action === 2 || action === 4) {
      // Assign All or Unassign All
      const params = {
        iriweek: this.data.iriWeek,
        territoryid: this.filterForm.get('territory')?.value,
        storenumber: this.data.storeNumber,
        empid: fsrId,
        tasknumber: '', // Empty for ALL
        positionnumber: this.data.positionNumber,
        action: action, // 2 or 4
        assignmentmode: 'StoreLevel',
        countryId: this.commonService.getCurrentCountry(),
      };

      console.log('Saving assignment (ALL):', params);

      await firstValueFrom(
        this.http.post(
          this.baseUrl + 'api/TaskAssinment/SaveAssignment',
          params
        )
      );
    } else if (action === 1 || action === 3) {
      // Assign or Unassign specific task(s)
      // Only process non-ALL rows
      const specificTasks = selectedRows.filter((row) => !row.isAllTask);
      
      if (specificTasks.length === 0) {
        alert('No specific tasks selected.');
        return;
      }

      // Process each specific task
      for (const row of specificTasks) {
        const params = {
          iriweek: this.data.iriWeek,
          territoryid: this.filterForm.get('territory')?.value,
          storenumber: row.storeNumber,
          empid: fsrId,
          tasknumber: row.taskNumber,
          positionnumber: this.data.positionNumber,
          action: action, // 1 or 3
          assignmentmode: 'TaskLevel',
          countryId: this.commonService.getCurrentCountry(),
        };

        console.log('Saving assignment (Specific Task):', params);

        await firstValueFrom(
          this.http.post(
            this.baseUrl + 'api/TaskAssinment/SaveAssignment',
            params
          )
        );
      }
    }

    this.hasChanges = true;

    // Reload all data to refresh the UI and button states
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    await this.loadProximityData();
    
    // Keep task selection (don't clear it)
    // so user can see what was just modified
    
    this.filterForm.patchValue({ firstName: '', lastName: '' });
    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment. Please try again.');
  } finally {
    this.showSpinner = false;
  }
}

// ============================================================
// EXAMPLE OF HOW THE NEW LOGIC WORKS:
// ============================================================

/*
SCENARIO 1: User selects "ALL" row in Table 3
- isAllTaskSelected() returns TRUE
- Both buttons check: !isAlreadyAssignedFsr(fsr)
- If FSR not assigned:
  * SHOW "Assign All" button (action=2)
  * HIDE "Unassign All" button
- If FSR is assigned:
  * HIDE "Assign All" button
  * SHOW "Unassign All" button (action=4)
- Result: Only ONE button visible

SCENARIO 2: User selects specific task (e.g., "Task A", "Task B") in Table 3
- isAllTaskSelected() returns FALSE
- taskSelection.selected.length > 0 returns TRUE
- Both buttons check: !isAlreadyAssignedFsr(fsr)
- If FSR not assigned:
  * SHOW "Assign" button (action=1)
  * HIDE "Unassign" button
- If FSR is assigned:
  * HIDE "Assign" button
  * SHOW "Unassign" button (action=3)
- Result: Only ONE button visible

SCENARIO 3: User has NOT selected any task in Table 3
- isAllTaskSelected() returns FALSE
- taskSelection.selected.length === 0 returns TRUE
- Both ng-containers have *ngIf that evaluate to FALSE
- Result: NO buttons visible (clean UI)
*/

.............

(click)="element.isChildRow ? openTaskAssignmentDialog2(element) : openAssignmentDialog(element, 'StoreLevel');"


// ============================================================
// AUTO-SELECT based on where user came from
// ============================================================
private autoSelectBasedOnOrigin(): void {
  setTimeout(() => {
    if (this.originMode === 'StoreLevel') {
      // User came from main grid - auto-select "ALL"
      const allRow = this.taskAssignmentDataSource.data.find(r => r.isAllTask);
      if (allRow) {
        this.taskSelection.select(allRow);
      }
    } else if (this.originMode === 'TaskLevel' && this.data.taskNumber) {
      // User came from subgrid - auto-select that specific task
      const taskRow = this.taskAssignmentDataSource.data.find(
        r => r.taskNumber === this.data.taskNumber && !r.isAllTask
      );
      if (taskRow) {
        this.taskSelection.select(taskRow);
      }
    }
  }, 100);
}

// ============================================================
// UNIFIED ASSIGN LOGIC - KEY FIX
// ============================================================
private async assignTaskWithSelection(fsr: any, source: 'proximity' | 'fsr'): Promise<void> {
  const selectedRows = this.taskSelection.selected;

  if (selectedRows.length === 0) {
    alert('Please select at least one task to assign.');
    return;
  }

  const fsrName = source === 'proximity' 
    ? `${fsr.firstName} ${fsr.lastName}` 
    : `${fsr.FirstName} ${fsr.LastName}`;
  const empId = source === 'proximity' ? fsr.empId : fsr.emp_id;

  // Check if "ALL" is selected
  const allSelected = selectedRows.some((row) => row.isAllTask);

  let confirmMessage = '';

  if (allSelected) {
    // User selected "ALL" row
    confirmMessage = `Are you sure you want to assign ${fsrName} to all tasks?`;
  } else {
    // User selected specific tasks
    const taskNames = selectedRows.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to assign ${fsrName} to ${taskNames}?`;
  }

  if (!confirm(confirmMessage)) return;

  this.showSpinner = true;
  try {
    if (allSelected) {
      // Assign to ALL tasks - Single API call
      const params = {
        iri_week: this.data.iriWeek,
        territory_id: this.filterForm.get('territory')?.value,
        store_number: this.data.storeNumber,
        emp_id: empId,
        task_number: '',
        position_number: this.data.positionNumber || '',
        action: 2, // Assign all
        assignment_mode: 'StoreLevel', // Use StoreLevel for "ALL"
        countryId: this.commonService.getCurrentCountry(),
      };

      await firstValueFrom(
        this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
      );
    } else {
      // Assign to SPECIFIC tasks - Multiple API calls
      // ðŸ”‘ KEY FIX: Use TaskLevel mode for each specific task
      for (const row of selectedRows) {
        const params = {
          iri_week: this.data.iriWeek,
          territory_id: this.filterForm.get('territory')?.value,
          store_number: row.storeNumber,
          emp_id: empId,
          task_number: row.taskNumber || '',
          position_number: this.data.positionNumber || '',
          action: 1, // Assign specific task
          assignment_mode: 'TaskLevel', // ðŸ”‘ ALWAYS TaskLevel for specific tasks
          countryId: this.commonService.getCurrentCountry(),
        };

        await firstValueFrom(
          this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
        );
      }
    }

    this.hasChanges = true;
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    this.taskSelection.clear();
    this.filterForm.patchValue({ firstName: '', lastName: '' });

    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment.');
  } finally {
    this.showSpinner = false;
  }
}

// ============================================================
// ACTION BUTTONS - Keep labels but logic depends on selection
// ============================================================
async assignTask(fsr: any, action: number): Promise<void> {
  // The action numbers here are for backward compatibility
  // but the actual logic now depends on task selection
  
  const actionNames: { [key: number]: string } = {
    1: 'assign to',
    2: 'assign to', // Keep label as "Assign All" even though behavior varies
    3: 'unassign from',
    4: 'unassign from',
    5: 'assign to cluster',
    6: 'unassign from cluster',
  };

  // Check what user has selected
  const selectedRows = this.taskSelection.selected;
  const allSelected = selectedRows.some((row) => row.isAllTask);

  // Determine the actual action based on selection
  let actualAction = action;
  let targetDescription = '';

  if (action === 2 || action === 4) {
    // These are "Assign All" / "Unassign All" buttons
    // But if user selected specific tasks, treat as specific assignment
    if (!allSelected && selectedRows.length > 0) {
      actualAction = action === 2 ? 1 : 3; // Convert to task-level action
      targetDescription = `${selectedRows.length} task(s)`;
    } else {
      targetDescription = 'all tasks';
    }
  }

  const message = `Are you sure you want to ${actionNames[actualAction]} ${fsr.FirstName} ${fsr.LastName} to ${targetDescription}?`;

  if (!confirm(message)) return;

  this.showSpinner = true;
  try {
    if (!allSelected && selectedRows.length > 0 && (action === 2 || action === 4)) {
      // User selected specific tasks but clicked "Assign All" button
      // Treat as task-level assignment
      const assignAction = action === 2 ? 1 : 3;
      
      for (const row of selectedRows) {
        const params = {
          iri_week: this.data.iriWeek,
          territory_id: this.filterForm.get('territory')?.value,
          store_number: row.storeNumber,
          emp_id: fsr.emp_id,
          task_number: row.taskNumber || '',
          position_number: this.data.positionNumber || '',
          action: assignAction,
          assignment_mode: 'TaskLevel', // ðŸ”‘ Use TaskLevel for specific
          countryId: this.commonService.getCurrentCountry(),
        };

        await firstValueFrom(
          this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
        );
      }
    } else {
      // Original logic for other cases
      const params = {
        iri_week: this.data.iriWeek,
        territory_id: this.filterForm.get('territory')?.value,
        store_number: this.data.storeNumber,
        emp_id: fsr.emp_id,
        task_number: this.data.taskNumber || '',
        position_number: this.data.positionNumber || '',
        action: actualAction,
        assignment_mode: allSelected ? 'StoreLevel' : 'TaskLevel',
        countryId: this.commonService.getCurrentCountry(),
      };

      await firstValueFrom(
        this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
      );
    }

    this.hasChanges = true;
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    this.filterForm.patchValue({ firstName: '', lastName: '' });

    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment.');
  } finally {
    this.showSpinner = false;
  }
}
