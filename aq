/**
 * Handle column visibility changes and preserve expansion state
 */
updateVisibleColumns(selectedColumns: string[]): void {
  // 1. Store current expansion state BEFORE column change
  const expandedStoreNumbers = new Set<string>();
  this.selectedRows.forEach(row => {
    if (row.StoreNumber) {
      expandedStoreNumbers.add(row.StoreNumber);
    }
  });

  // 2. Update the visible columns
  this.visibleColumns = selectedColumns;
  this.updateDisplayedColumns();

  // 3. Force change detection to re-render table
  this.cdr.detectChanges();

  // 4. After view update, restore the directive expansion states
  setTimeout(() => {
    this.restoreExpansionStates(expandedStoreNumbers);
  }, 0);
}

/**
 * Restore expansion states after table re-render
 */
private restoreExpansionStates(expandedStoreNumbers: Set<string>): void {
  const detailRowsArray = this.detailRows?.toArray() || [];
  const currentPageData = this.getCurrentPageData();

  // Loop through current page rows and restore their expansion state
  currentPageData.forEach((parentRow, index) => {
    const detailRowDirective = detailRowsArray[index];
    
    if (!detailRowDirective || !parentRow.StoreNumber) return;

    // Check if this row should be expanded
    const shouldBeExpanded = expandedStoreNumbers.has(parentRow.StoreNumber);

    if (shouldBeExpanded) {
      // Manually set the directive to expanded state WITHOUT triggering toggle
      detailRowDirective.expended = true; // Note: Check your directive - might be 'expended' or 'isExpanded'
      
      // Make sure the directive is in our tracking set
      this.expandedRows.add(detailRowDirective);
      this.selectedRows.add(parentRow);
    }
  });

  // Final change detection to update icon states
  this.cdr.detectChanges();
}

/**
 * Check if a row is expanded (used for caret rotation)
 */
isRowExpanded(element: any): boolean {
  if (!element || !element.StoreNumber) return false;
  
  // Check if this specific row is in the expanded set
  return Array.from(this.selectedRows).some(
    row => row.StoreNumber === element.StoreNumber
  );
}
