// ============================================================
// AUTO-SELECT based on where user came from
// ============================================================
private autoSelectBasedOnOrigin(): void {
  setTimeout(() => {
    if (this.originMode === 'StoreLevel') {
      // User came from main grid - auto-select "ALL"
      const allRow = this.taskAssignmentDataSource.data.find(r => r.isAllTask);
      if (allRow) {
        this.taskSelection.select(allRow);
      }
    } else if (this.originMode === 'TaskLevel' && this.data.taskNumber) {
      // User came from subgrid - auto-select that specific task
      const taskRow = this.taskAssignmentDataSource.data.find(
        r => r.taskNumber === this.data.taskNumber && !r.isAllTask
      );
      if (taskRow) {
        this.taskSelection.select(taskRow);
      }
    }
  }, 100);
}

// ============================================================
// UNIFIED ASSIGN LOGIC - KEY FIX
// ============================================================
private async assignTaskWithSelection(fsr: any, source: 'proximity' | 'fsr'): Promise<void> {
  const selectedRows = this.taskSelection.selected;

  if (selectedRows.length === 0) {
    alert('Please select at least one task to assign.');
    return;
  }

  const fsrName = source === 'proximity' 
    ? `${fsr.firstName} ${fsr.lastName}` 
    : `${fsr.FirstName} ${fsr.LastName}`;
  const empId = source === 'proximity' ? fsr.empId : fsr.emp_id;

  // Check if "ALL" is selected
  const allSelected = selectedRows.some((row) => row.isAllTask);

  let confirmMessage = '';

  if (allSelected) {
    // User selected "ALL" row
    confirmMessage = `Are you sure you want to assign ${fsrName} to all tasks?`;
  } else {
    // User selected specific tasks
    const taskNames = selectedRows.map((row) => row.taskName).join(', ');
    confirmMessage = `Are you sure you want to assign ${fsrName} to ${taskNames}?`;
  }

  if (!confirm(confirmMessage)) return;

  this.showSpinner = true;
  try {
    if (allSelected) {
      // Assign to ALL tasks - Single API call
      const params = {
        iri_week: this.data.iriWeek,
        territory_id: this.filterForm.get('territory')?.value,
        store_number: this.data.storeNumber,
        emp_id: empId,
        task_number: '',
        position_number: this.data.positionNumber || '',
        action: 2, // Assign all
        assignment_mode: 'StoreLevel', // Use StoreLevel for "ALL"
        countryId: this.commonService.getCurrentCountry(),
      };

      await firstValueFrom(
        this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
      );
    } else {
      // Assign to SPECIFIC tasks - Multiple API calls
      // ðŸ”‘ KEY FIX: Use TaskLevel mode for each specific task
      for (const row of selectedRows) {
        const params = {
          iri_week: this.data.iriWeek,
          territory_id: this.filterForm.get('territory')?.value,
          store_number: row.storeNumber,
          emp_id: empId,
          task_number: row.taskNumber || '',
          position_number: this.data.positionNumber || '',
          action: 1, // Assign specific task
          assignment_mode: 'TaskLevel', // ðŸ”‘ ALWAYS TaskLevel for specific tasks
          countryId: this.commonService.getCurrentCountry(),
        };

        await firstValueFrom(
          this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
        );
      }
    }

    this.hasChanges = true;
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    this.taskSelection.clear();
    this.filterForm.patchValue({ firstName: '', lastName: '' });

    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment.');
  } finally {
    this.showSpinner = false;
  }
}

// ============================================================
// ACTION BUTTONS - Keep labels but logic depends on selection
// ============================================================
async assignTask(fsr: any, action: number): Promise<void> {
  // The action numbers here are for backward compatibility
  // but the actual logic now depends on task selection
  
  const actionNames: { [key: number]: string } = {
    1: 'assign to',
    2: 'assign to', // Keep label as "Assign All" even though behavior varies
    3: 'unassign from',
    4: 'unassign from',
    5: 'assign to cluster',
    6: 'unassign from cluster',
  };

  // Check what user has selected
  const selectedRows = this.taskSelection.selected;
  const allSelected = selectedRows.some((row) => row.isAllTask);

  // Determine the actual action based on selection
  let actualAction = action;
  let targetDescription = '';

  if (action === 2 || action === 4) {
    // These are "Assign All" / "Unassign All" buttons
    // But if user selected specific tasks, treat as specific assignment
    if (!allSelected && selectedRows.length > 0) {
      actualAction = action === 2 ? 1 : 3; // Convert to task-level action
      targetDescription = `${selectedRows.length} task(s)`;
    } else {
      targetDescription = 'all tasks';
    }
  }

  const message = `Are you sure you want to ${actionNames[actualAction]} ${fsr.FirstName} ${fsr.LastName} to ${targetDescription}?`;

  if (!confirm(message)) return;

  this.showSpinner = true;
  try {
    if (!allSelected && selectedRows.length > 0 && (action === 2 || action === 4)) {
      // User selected specific tasks but clicked "Assign All" button
      // Treat as task-level assignment
      const assignAction = action === 2 ? 1 : 3;
      
      for (const row of selectedRows) {
        const params = {
          iri_week: this.data.iriWeek,
          territory_id: this.filterForm.get('territory')?.value,
          store_number: row.storeNumber,
          emp_id: fsr.emp_id,
          task_number: row.taskNumber || '',
          position_number: this.data.positionNumber || '',
          action: assignAction,
          assignment_mode: 'TaskLevel', // ðŸ”‘ Use TaskLevel for specific
          countryId: this.commonService.getCurrentCountry(),
        };

        await firstValueFrom(
          this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
        );
      }
    } else {
      // Original logic for other cases
      const params = {
        iri_week: this.data.iriWeek,
        territory_id: this.filterForm.get('territory')?.value,
        store_number: this.data.storeNumber,
        emp_id: fsr.emp_id,
        task_number: this.data.taskNumber || '',
        position_number: this.data.positionNumber || '',
        action: actualAction,
        assignment_mode: allSelected ? 'StoreLevel' : 'TaskLevel',
        countryId: this.commonService.getCurrentCountry(),
      };

      await firstValueFrom(
        this.http.post(this.baseUrl + 'api/TaskAssinment/SaveAssignment', params)
      );
    }

    this.hasChanges = true;
    await this.loadCurrentAssignment();
    await this.loadTaskAssignmentData();
    this.filterForm.patchValue({ firstName: '', lastName: '' });

    alert('Assignment saved successfully.');
  } catch (error) {
    console.error('Error saving assignment:', error);
    alert('Error while saving assignment.');
  } finally {
    this.showSpinner = false;
  }
}
